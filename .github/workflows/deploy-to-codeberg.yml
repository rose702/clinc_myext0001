name: Deploy to Codeberg

on:
  push:
    branches:
      - main

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure Codeberg repo exists
        env:
          CODEBERG_USERNAME: ${{ secrets.CODEBERG_USERNAME }}
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
          CODEBERG_REPO: clinc_myext0001
          CODEBERG_BASE: https://codeberg.org
        run: |
          if [ -z "$CODEBERG_USERNAME" ] || [ -z "$CODEBERG_TOKEN" ]; then
            echo "CODEBERG_USERNAME or CODEBERG_TOKEN not set; skipping repo creation"
            exit 0
          fi
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${CODEBERG_BASE}/api/v1/repos/${CODEBERG_USERNAME}/${CODEBERG_REPO}")
          if [ "$STATUS" = "404" ]; then
            echo "Codeberg repo not found; creating ${CODEBERG_USERNAME}/${CODEBERG_REPO}"
            # Use Basic Auth (username:token) which is commonly required by Forgejo deployments
            CREATE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -u "${CODEBERG_USERNAME}:${CODEBERG_TOKEN}" -H "Content-Type: application/json" -X POST "${CODEBERG_BASE}/api/v1/user/repos" -d "{\"name\":\"${CODEBERG_REPO}\",\"private\":false,\"description\":\"Mirror of GitHub repo\"}")
            if [ "$CREATE_STATUS" -ge 200 ] && [ "$CREATE_STATUS" -lt 300 ]; then
              echo "Codeberg repo created successfully"
            else
              echo "Warning: Failed to create Codeberg repo via API (status ${CREATE_STATUS}). If this persists, create the repo manually and re-run."
            fi
          else
            echo "Codeberg repo exists (status ${STATUS})"
          fi

      - name: Push to Codeberg
        env:
          CODEBERG_USERNAME: ${{ secrets.CODEBERG_USERNAME }}
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          # Build Basic Auth header to avoid putting credentials in the URL
          AUTH_HEADER=$(printf '%s:%s' "$CODEBERG_USERNAME" "$CODEBERG_TOKEN" | base64)
          TARGET_URL="https://codeberg.org/${CODEBERG_USERNAME}/clinc_myext0001.git"

          # Push using Authorization header
          git -c http.extraheader="Authorization: Basic ${AUTH_HEADER}" push -u "${TARGET_URL}" main
